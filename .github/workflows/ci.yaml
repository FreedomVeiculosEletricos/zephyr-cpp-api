# Copyright 2022 Freedom Veículos Elétricos LTDA.
# SPDX-License-Identifier: Apache-2.0

name: CI

on:
  push:
    branches:
      - main
      - 'releases/**'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          path: zephyr-c++-api

      - uses: cachix/install-nix-action@v17

      - uses: cachix/cachix-action@v12
        with:
          name: freedom-zephyr-cpp-api
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Evaluate Nix Development Shell
        working-directory: zephyr-c++-api
        run: |
          # Does nothing but ensures we have a clear understand of time spent during download and
          # evaluation of the shell expression.
          nix develop

      - name: Check Code Formatting
        uses: workflow/nix-shell-action@v3.2.0
        with:
          working-directory: zephyr-c++-api
          script: |
            ./scripts/format-code

            if [ -n "$(git status --untracked-files=no --porcelain=v1)" ]; then
                echo "ERROR: Code is not properly formatted"
                git diff
                exit 1
            fi

      - name: Check License Headers
        uses: workflow/nix-shell-action@v3.2.0
        with:
          working-directory: zephyr-c++-api
          script: |
            set -x
            ./scripts/license-headers

            if [ -n "$(git status --untracked-files=no --porcelain=v1)" ]; then
                echo "ERROR: Missing license on one or more headers"
                git diff
                exit 1
            fi

      - name: Initialize
        uses: workflow/nix-shell-action@v3.2.0
        with:
          working-directory: zephyr-c++-api
          script: |
            west init -l .
            west update

      - name: Twister Tests
        uses: workflow/nix-shell-action@v3.2.0
        with:
          working-directory: zephyr-c++-api
          script: |
            ./scripts/run-tests
